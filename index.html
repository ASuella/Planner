<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>PLANNING POGGIO 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 30px;
    }

    .month {
      margin-bottom: 40px;
    }

    .month h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #333;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 5px;
      position: relative;
    }

    th {
      background: #eee;
      font-size: 12px;
    }

    .day-label {
      font-size: 10px;
      color: #666;
      display: block;
    }

    .booking-bar {
      position: absolute;
      top: 0;
      bottom: 0;
      margin: 2px 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px solid #333; /* bordo aggiunto */
    }

    .booking-future { background: #007bff; }
    .booking-past { background: #dc3545; }
    .booking-active { background: #28a745; }

    .today {
      background: #fffae6 !important;
    }
  </style>
</head>
<body>
  <h1>PLANNING POGGIO 2025</h1>
  <div id="planner"></div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT32ylCoynwf1H44moYbc5n42UMdGEHUtzE6SZ7kc1P7rcwA-NkAEpck9jO0bVRWYRcakvb0VEd5cEJ/pub?gid=0&single=true&output=csv";

    const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    const dayNames = ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"];
    const today = new Date();

    async function loadCSV() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      return text.split("\n").slice(1).map(row => {
        const cols = row.split(",");
        if (cols.length < 4) return null;
        const cliente = cols[0].trim();
        const camere = cols[1].trim();
        const checkin = new Date(cols[2].trim());
        const notti = parseInt(cols[3].trim());
        if (!cliente || isNaN(checkin) || isNaN(notti)) return null;
        const checkout = new Date(checkin);
        checkout.setDate(checkin.getDate() + notti);
        return { cliente, camere, checkin, checkout, notti };
      }).filter(x => x);
    }

    function createPlanner(bookings) {
      const planner = document.getElementById("planner");
      planner.innerHTML = "";

      for (let m = 0; m < 12; m++) {
        const monthDiv = document.createElement("div");
        monthDiv.className = "month";

        const title = document.createElement("h2");
        title.textContent = monthNames[m];
        monthDiv.appendChild(title);

        const table = document.createElement("table");
        const header = document.createElement("tr");
        header.appendChild(document.createElement("th")).textContent = "Camera";

        const daysInMonth = new Date(2025, m + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const th = document.createElement("th");
          th.innerHTML = `${d}<span class="day-label">${dayNames[new Date(2025, m, d).getDay()]}</span>`;
          if (today.getFullYear() === 2025 && today.getMonth() === m && today.getDate() === d) {
            th.classList.add("today");
          }
          header.appendChild(th);
        }
        table.appendChild(header);

        ["Camera 1","Camera 2","Camera 3"].forEach(camera => {
          const row = document.createElement("tr");
          const tdCamera = document.createElement("td");
          tdCamera.textContent = camera;
          row.appendChild(tdCamera);

          for (let d = 1; d <= daysInMonth; d++) {
            const td = document.createElement("td");
            if (today.getFullYear() === 2025 && today.getMonth() === m && today.getDate() === d) {
              td.classList.add("today");
            }
            row.appendChild(td);
          }
          table.appendChild(row);
        });

        monthDiv.appendChild(table);
        planner.appendChild(monthDiv);

        // Inserisci prenotazioni
        bookings.forEach(b => {
          if (!b.camere.includes("Camera")) return;
          const startMonth = b.checkin.getMonth();
          const endMonth = b.checkout.getMonth();
          if (m < startMonth || m > endMonth) return;

          b.camere.split("&").forEach(cameraName => {
            cameraName = cameraName.trim();
            const rows = table.querySelectorAll("tr");
            let row;
            rows.forEach(r => {
              if (r.firstChild && r.firstChild.textContent === cameraName) row = r;
            });
            if (!row) return;

            const days = row.querySelectorAll("td");
            let startDay = (m === startMonth) ? b.checkin.getDate() : 1;
            let endDay = (m === endMonth) ? b.checkout.getDate() : days.length - 1;

            const startCell = days[startDay];
            const endCell = days[endDay - 1];
            if (!startCell || !endCell) return;

            const bar = document.createElement("div");
            bar.className = "booking-bar";

            // Stato prenotazione
            const now = new Date();
            if (b.checkout <= now) bar.classList.add("booking-past");
            else if (b.checkin > now) bar.classList.add("booking-future");
            else bar.classList.add("booking-active");

            bar.textContent = b.cliente;

            // Posizionamento grafico met√† casella in/out
            const startRect = startCell.getBoundingClientRect();
            const endRect = endCell.getBoundingClientRect();
            const offsetLeft = startCell.offsetLeft + startCell.offsetWidth / 2;
            const offsetRight = endCell.offsetLeft + endCell.offsetWidth / 2 + endCell.offsetWidth;

            bar.style.left = offsetLeft + "px";
            bar.style.width = (offsetRight - offsetLeft) + "px";

            startCell.parentElement.appendChild(bar);

            // Tooltip al click
            bar.title = `${b.cliente}\n${b.camere}\nCheck-in: ${b.checkin.toLocaleDateString()}\nCheck-out: ${b.checkout.toLocaleDateString()}\nNotti: ${b.notti}`;
          });
        });
      }
    }

    async function init() {
      const bookings = await loadCSV();
      createPlanner(bookings);
    }

    init();
    setInterval(init, 5 * 60 * 1000); // refresh ogni 5 minuti
  </script>
</body>
</html>
